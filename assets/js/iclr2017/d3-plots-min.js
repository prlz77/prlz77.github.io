function create_dataset(e){var a=[],t=[];for(i=0;i<e;i++)a.push([Math.random()-.5,Math.random()-.5]),t.push([Math.ceil(255*Math.random()),Math.ceil(255*Math.random()),Math.ceil(255*Math.random())]);return[a,t]}function Regularizer(e,a,t,r,n){this.dataset=e,this.orthoreg=a,this.scatterHandler=t,this.min_angle=[{x:null,y:null}],this.active=!0,this.line=d3.line().curve(d3.curveBasis).x(function(e){return xAngleScale(e.x)}).y(function(e){return yAngleScale(e.y)}),this.angleHandler=r.append("path").attr("stroke",n).attr("class","line").attr("d",this.line(this.min_angle)),Regularizer.nactive=Regularizer.nactive+1}function SquashingGraph(){var e=d3.scaleLinear().domain([-Math.PI,Math.PI]).range([30,270]),a=d3.scaleLinear().domain([0,1]).range([270,30]),t=d3.scaleLinear().domain([-Math.PI,Math.PI]).range([30,270]),r=d3.scaleLinear().domain([-.01,.7]).range([270,30]),n=function(e,a,t,r){for(var n=[],i=(a-e)/t,l=0;l<=t;l++)n.push({x:e+l*i,y:Math.log(1+Math.exp(r*Math.cos(e+l*i)-r))});return n},i=d3.select("#squashing").append("svg").attr("width","100%").attr("height","100%").attr("viewBox","0 0 300 300").attr("preserveAspectRatio","xMidYMid meet"),l=d3.line().curve(d3.curveBasis).x(function(a){return e(a.x)}).y(function(e){return a(e.y)}),c=d3.line().curve(d3.curveBasis).x(function(e){return t(e.x)}).y(function(e){return r(e.y)}),u=(i.append("path").attr("stroke","steelblue").attr("class","line").attr("d",l(function(e,a,t){for(var r=[],n=(a-e)/t,i=0;i<=t;i++)r.push({x:e+i*n,y:Math.pow(Math.cos(e+i*n),2)});return r}(-Math.PI,Math.PI,20))),i.append("path").attr("stroke","red").attr("class","line squash-line").attr("d",c(n(-Math.PI,Math.PI,20,10))));i.append("g").attr("transform","translate(30, 0)").call(d3.axisLeft(a)),i.append("g").attr("transform","translate(0,270)").call(d3.axisBottom(e).tickValues([-Math.PI,-Math.PI/2,0,Math.PI/2,Math.PI]).tickFormat(function(e,a){return["-pi","pi / 2","0","pi / 2","pi"][a]})),this.updateGraph=function(e){u.attr("d",c(n(-Math.PI,Math.PI,20,e)))}}function initScatterGraphics(e,a,t){var n=e.selectAll("line").data(a);n.enter().append("line").attr("x1",function(e){return xScale(e[0])}).attr("y1",function(e){return yScale(e[1])}).attr("x2",function(e){return w/2}).attr("y2",function(e){return h/2}).attr("stroke","gray"),n.exit().remove();var i=e.selectAll("circle").data(a);i.enter().append("circle").attr("cx",function(e){return xScale(e[0])}).attr("cy",function(e){return yScale(e[1])}).attr("r",r),i.exit().remove(),e.selectAll("circle").data(t).attr("fill",function(e){return"rgb("+e[0]+","+e[1]+","+e[2]+")"}).attr("opacity",.98)}function updateData(e,a,t,r){var n=e.map(numeric.norm2);n=numeric.transpose([n,n]);var i=numeric.div(e,n),l=numeric.dot(i,numeric.transpose(i)),c=numeric.acos(l),u=0;numeric.abseq(c);for(var s=0;s<c.length;s++)c[s][s]=1/0,u+=d3.min(c[s]);a&&(numeric.muleq(l,r),numeric.expeq(l),l=numeric.div(numeric.mul(r,l),numeric.add(l,Math.exp(r))));var d=numeric.sub(1,numeric.identity(l.length));l=numeric.mul(l,d),l=numeric.dot(l,i),l=numeric.mul(l,t/e.length),numeric.addeq(e,l);var g=e.map(numeric.norm2);return numeric.diveq(e,numeric.transpose([g,g])),numeric.muleq(e,n),u}function updateScatterGraphics(e,a){e.selectAll("circle").data(a).transition().attr("cx",function(e){return xScale(e[0])}).attr("cy",function(e){return yScale(e[1])}),e.selectAll("line").data(a).transition().attr("x1",function(e){return xScale(e[0])}).attr("y1",function(e){return yScale(e[1])}).attr("x2",function(e){return w/2}).attr("y2",function(e){return h/2});var t=d3.extent(a,function(e){return e[0]}),r=xScale.domain(),n=d3.extent(a,function(e){return e[1]}),i=yScale.domain();xScale.domain([Math.min(t[0],r[0]),Math.max(t[1],r[1])]),yScale.domain([Math.min(n[0],i[0]),Math.max(n[1],i[1])])}function updateAngleGraphics(e,a,t){e.attr("d",a(t))}function updateAxis(e,a){xAngleScale.domain([0,a]),yAngleScale.domain([0,e]),d3.select(".x.axis").call(d3.axisBottom(xAngleScale)),d3.select(".y.axis").call(d3.axisLeft(yAngleScale).ticks(5))}function scatterStart(){interval_id>=0&&clearInterval(interval_id);var e=+document.getElementById("N").value,a=-1*document.getElementById("alpha").value,t=+document.getElementById("lambda").value;t>30&&(document.getElementById("lambda").value=30);var r=create_dataset(e),n=r[0],i=r[1],l=+document.getElementById("delta").value,c=+document.getElementById("maxIter").value-1;0==regularizers.length?(xScale=d3.scaleLinear().domain(d3.extent(n,function(e){return e[0]})).range([scatterMargin,w-scatterMargin]),xAngleScale=d3.scaleLinear().domain([0,1]).range([angleMargin,w]),yScale=d3.scaleLinear().domain(d3.extent(n,function(e){return e[1]})).range([h-scatterMargin,scatterMargin]),yAngleScale=d3.scaleLinear().domain([0,1]).range([h_angle-angleMargin,angleMargin]),angleHandler.append("g").attr("class","x axis").attr("transform","translate(0,"+(h_angle-angleMargin)+")").call(d3.axisBottom(xAngleScale)),angleHandler.append("g").attr("class","y axis").attr("transform","translate("+angleMargin+", 0)").call(d3.axisLeft(yAngleScale).ticks(5)),regularizers.push(new Regularizer(n,!1,baselineScatterHandler,angleHandler,"steelblue")),regularizers.push(new Regularizer(numeric.clone(n),!0,orthoregScatterHandler,angleHandler,"#F08080"))):(regularizers[0].dataset=n,regularizers[0].min_angle=[{x:0,y:0}],regularizers[0].active=!0,regularizers[1].dataset=numeric.clone(n),regularizers[1].min_angle=[{x:0,y:0}],regularizers[1].active=!0);for(var u=0;u<regularizers.length;u++)initScatterGraphics(regularizers[u].scatterHandler,regularizers[u].dataset,i);Regularizer.nactive=2;var s=0,d=0;interval_id=setInterval(function(){s+=1,updateAxis(d,s);for(var e=0;e<regularizers.length;e++)if(regularizers[e].active){var r=updateData(regularizers[e].dataset,regularizers[e].orthoreg,a,t);d=Math.max(d,r),Math.abs(r-regularizers[e].min_angle[regularizers[e].min_angle.length-1].y)<l||s>c?(regularizers[e].active=!1,Regularizer.nactive=Regularizer.nactive-1):regularizers[e].min_angle.push({x:s,y:r}),updateScatterGraphics(regularizers[e].scatterHandler,regularizers[e].dataset),updateAngleGraphics(regularizers[e].angleHandler,regularizers[e].line,regularizers[e].min_angle)}else updateAngleGraphics(regularizers[e].angleHandler,regularizers[e].line,regularizers[e].min_angle);0==Regularizer.nactive&&(clearInterval(interval_id),interval_id=null)},200)}var xScale,yScale,xAngleScale,yAngleScale,scatterMargin=20,angleMargin=30,w=500,h=500,w_angle=500,h_angle=125,r=10,maxIter=100,regularizers=[],baselineScatterHandler=d3.select("#baseline").append("svg").attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+w+" "+h).attr("preserveAspectRatio","xMidYMid meet"),orthoregScatterHandler=d3.select("#orthoreg").append("svg").attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+w+" "+h).attr("preserveAspectRatio","xMidYMid meet"),angleHandler=d3.select("#angle").append("svg").attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+w_angle+" "+h_angle).attr("preserveAspectRatio","xMidYMid meet"),interval_id=-1;
